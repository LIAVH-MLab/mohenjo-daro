<html>

<meta charset="UTF-8">

<head>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.min.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu&family=Work+Sans:wght@300&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Work Sans', sans-serif;
        }
        
        svg {
            font-family: 'Work Sans', sans-serif;
            font-weight: 200;
        }
        
        #tooltip {
            text-align: left;
            position: absolute;
            padding: 3px;
            font-size: 10px;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            max-width: 150px;
        }
        
        #tooltip img {
            width: 90px;
            height: auto;
        }
        
        â€‹
    </style>
</head>

<body>
    <svg id="container"></svg>
</body>

<script>
    d3.csv("https://raw.githubusercontent.com/PrattSAVI/LIAVH/master/data/Processed_Data.csv", function(error, data) {

        //Filter Artefacts
        let arts = _.filter(data, {
            'N1': "Artefacts",
        });

        // Create Block_House Variable
        arts = arts.map(d => ({
            Class: d.Class,
            Block: d.Block,
            House: d.House,
            level: +d.Level_ft,
            Plate: d.Plate,
            Room: d.Room,
            Text: d.Text,
            Time_Cat: d.Time_Cat,
            Type: d.Type,
            photo: d.photo,
            loc: d.Block + '-' + d.House
        }));

        // Sort by Block - House (Loc)
        arts = _.sortBy(arts, [function(d) {
            return d.loc;
        }]);

        console.log(arts);

        // Config
        let width = 800;
        let height = 500;

        let margin = {
            top: 50,
            bottom: 50,
            left: 25,
            right: 10
        }

        // Create Scales
        let min = d3.min(arts.map(d => d.level))
        let max = d3.max(arts.map(d => d.level))

        // --x
        let xScale = d3.scaleBand()
            .range([0, width - margin.left - margin.right])
            .domain(arts.map(d => d.loc)) //Y axis Labels are Airline Names
            .padding(0.25)
            // --y
        let yScale = d3.scaleLinear()
            .domain([min, max])
            .range([(height - margin.top - margin.bottom), 0]);
        // --color
        let sectors = Array.from(new Set(arts.map((d) => d.Class))); //Get Unique
        let color = d3.scaleOrdinal().domain(sectors).range(["blue", "red", "purple", "orange"]);

        let container = d3.selectAll("#container");
        container.attr("height", height).attr("width", width);

        let body = container.append("g")
            .style("transform", `translate(${margin.left}px,${margin.top}px)`);

        let locs = Array.from(new Set(arts.map((d) => d.loc))); //Get Unique
        let grid = body.selectAll("line")
            .data(locs).enter()
            .append("line")
            .attr("class", "horizontalGrid")
            .attr("y1", 0)
            .attr("y2", height - margin.bottom - margin.top)
            .attr("x1", d => xScale(d))
            .attr("x2", d => xScale(d))
            .attr("fill", "none")
            .attr("stroke", "black")
            .attr("stroke-width", ".01em")

        // Scatter Plot
        let rad = 2.5
        let join = body.selectAll("circle")
            .data(arts).enter()
            .append("circle")
            .attr("class", "circ")
            .attr("cx", d => xScale(d.loc))
            .attr("cy", d => yScale(d.level))
            .attr("r", rad)
            .attr("fill", (d) => color(d.Class));

        // Collusion Detection
        let simulation = d3.forceSimulation(arts)
            .force("x", d3.forceX((d) => {
                return xScale(d.loc);
            }).strength(0.2))
            .force("y", d3.forceY((d) => {
                return yScale(d.level);
            }).strength(1))
            .force("collide", d3.forceCollide(rad))
            .alphaDecay(0)
            .alpha(0.3)
            .on("tick", tick);

        function tick() {
            d3.selectAll(".circ")
                .attr("cx", (d) => d.x)
                .attr("cy", (d) => d.y);
        }

        let init_decay = setTimeout(function() {
            console.log("start alpha decay");
            simulation.alphaDecay(0.1);
        }, 3000); // start decay after 3 seconds

        // Axis
        //----x Ordinal Scale
        let xAxis = d3.axisBottom(xScale);
        container.append("g")
            .attr("class", "x axis")
            .attr("id", "x")
            .style("transform", `translate(${margin.left}px,${height-margin.bottom}px)`)
            .style("font-size", "11px")
            .call(xAxis)
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("transform", function(d) {
                return "rotate(-90)";
            })
            .attr("dx", "-.8em")
            .attr("dy", "-5px");

        // TOOLTIP
        d3.select('body')
            .append('div')
            .attr('id', 'tooltip')
            .attr('style', 'opacity: 0;');

        join.on('mouseover', function(d) {
                d3.select('#tooltip')
                    .transition().duration(200)
                    .style('opacity', 1)
            })
            .on('mouseout', function(d) {
                d3.select('#tooltip')
                    .transition().duration(200)
                    .style('opacity', 0)
            })
            .on('mousemove', function(d) {

                let px = d3.mouse(this)[0] + margin.left + 10
                let py = d3.mouse(this)[1] + margin.top - 10

                d3.select('#tooltip')
                    .style('left', px + 'px')
                    .style('top', py + 'px')
                    .style("background-color", "rgb(255,255,255,0.8)")
                    .html(`<p><b>Location:</b></br> ${d.Block}-${d.House}-${d.Room}</p><p><b>Class:</b>${d.Class}</p><p><b>Type:</b> ${d.Type}</p><p><b>Description</b></br>${d.Text}</p><img src=${d.photo}></img>`)
            })

    })
</script>


</html>